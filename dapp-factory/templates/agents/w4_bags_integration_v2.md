# W4: Bags Integration (Bags-Compliant)\n\n## AGENT-NATIVE EXECUTION\nYou are Claude executing W4 for Web3 Factory. Configure Bags SDK for deterministic token creation based on official Bags documentation.\n\n## AUTHORITATIVE SOURCES (MANDATORY)\n\nALL Bags-related implementation MUST reference these official sources:\n\n- **Launch Token Guide**: https://docs.bags.fm/how-to-guides/launch-token\n- **TypeScript Setup**: https://docs.bags.fm/how-to-guides/typescript-node-setup\n- **Program IDs**: https://docs.bags.fm/principles/program-ids\n- **Lookup Tables**: https://docs.bags.fm/principles/lookup-tables\n- **Rate Limits**: https://docs.bags.fm/principles/rate-limits\n- **Error Handling**: https://docs.bags.fm/principles/error-handling\n- **File Uploads**: https://docs.bags.fm/principles/file-uploads\n- **Tipping**: https://docs.bags.fm/principles/tipping\n- **API Key Management**: https://docs.bags.fm/principles/api-key-management\n- **Base URL Versioning**: https://docs.bags.fm/principles/base-url-versioning\n\n**CRITICAL RULES**:\n- Use ONLY documented SDK methods and API endpoints\n- Follow exact parameter names and types from documentation\n- Implement rate limiting and error handling per principles\n- Use centralized constants from `/web3-factory/constants/`\n- All configuration must be deterministic and idempotent\n\n## CONFIGURATION ONLY STAGE\n\n**W4 DOES NOT CREATE TOKENS** - Configuration and validation only.\n\nW4 prepares all parameters for token creation in W5 based on official Bags patterns:\n1. `createTokenInfoAndMetadata()` parameters\n2. `createBagsFeeShareConfig()` parameters\n3. `createLaunchTransaction()` parameters\n\n## INPUTS\n- Read: `web3-factory/runs/.../w1/web3_idea.json`\n- Read: `web3-factory/runs/.../w2/token_model.json`\n- Read: `web3-factory/runs/.../w3/web3_architecture.json`\n\n## OUTPUTS\n- Write: `web3-factory/runs/.../w4/bags_config.json`\n- Write: `web3-factory/runs/.../w4/w4_execution.md`\n\n## JSON SCHEMA (BAGS-COMPLIANT)\n```json\n{\n  \"type\": \"object\",\n  \"properties\": {\n    \"token_metadata\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"name\": {\"type\": \"string\", \"maxLength\": 32},\n        \"symbol\": {\"type\": \"string\", \"maxLength\": 10},\n        \"description\": {\"type\": \"string\", \"maxLength\": 500},\n        \"image\": {\"type\": \"string\", \"format\": \"uri\"},\n        \"website\": {\"type\": \"string\", \"format\": \"uri\"},\n        \"twitter\": {\"type\": \"string\"},\n        \"telegram\": {\"type\": \"string\"}\n      },\n      \"required\": [\"name\", \"symbol\", \"description\"]\n    },\n    \"token_launch_params\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"initialBuyAmount\": {\"type\": \"string\"},\n        \"totalSupply\": {\"type\": \"string\"},\n        \"decimals\": {\"type\": \"number\", \"enum\": [9]}\n      },\n      \"required\": [\"initialBuyAmount\"]\n    },\n    \"fee_share_config\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"partner_attribution\": {\n          \"type\": \"object\",\n          \"properties\": {\n            \"partner_key\": {\"type\": \"string\", \"enum\": [\"FDYcVLxHkekUFz4M29hCuBH3vbf1aLm62GEFZxLFdGE7\"]},\n            \"partner_program\": {\"type\": \"string\", \"enum\": [\"app-factory\"]}\n          },\n          \"required\": [\"partner_key\", \"partner_program\"]\n        },\n        \"fee_claimers\": {\n          \"type\": \"array\",\n          \"items\": {\n            \"type\": \"object\",\n            \"properties\": {\n              \"wallet\": {\"type\": \"string\"},\n              \"bps\": {\"type\": \"number\", \"minimum\": 1, \"maximum\": 10000}\n            },\n            \"required\": [\"wallet\", \"bps\"]\n          },\n          \"maxItems\": 100\n        },\n        \"total_bps\": {\"type\": \"number\", \"enum\": [7500]}\n      },\n      \"required\": [\"partner_attribution\", \"fee_claimers\", \"total_bps\"]\n    },\n    \"lookup_table_config\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"use_bags_lut\": {\"type\": \"boolean\"},\n        \"bags_lut_address\": {\"type\": \"string\"},\n        \"custom_lut_required\": {\"type\": \"boolean\"},\n        \"fee_claimers_count\": {\"type\": \"number\"},\n        \"lut_threshold\": {\"type\": \"number\", \"enum\": [15]}\n      },\n      \"required\": [\"use_bags_lut\", \"custom_lut_required\", \"fee_claimers_count\", \"lut_threshold\"]\n    },\n    \"tipping_config\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"enabled\": {\"type\": \"boolean\"},\n        \"tip_wallet\": {\"type\": \"string\"},\n        \"tip_lamports\": {\"type\": \"number\", \"minimum\": 1000},\n        \"provider\": {\"type\": \"string\", \"enum\": [\"jito\", \"bloxroute\", \"astral\", \"custom\"]}\n      },\n      \"required\": [\"enabled\"]\n    },\n    \"environment_config\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"network\": {\"type\": \"string\", \"enum\": [\"mainnet-beta\", \"devnet\"]},\n        \"rpc_url\": {\"type\": \"string\", \"format\": \"uri\"},\n        \"api_base_url\": {\"type\": \"string\", \"enum\": [\"https://public-api-v2.bags.fm/api/v1/\"]},\n        \"api_version\": {\"type\": \"string\", \"enum\": [\"v1\"]},\n        \"required_env_vars\": {\"type\": \"array\", \"items\": {\"type\": \"string\"}}\n      },\n      \"required\": [\"network\", \"api_base_url\", \"api_version\", \"required_env_vars\"]\n    },\n    \"program_ids\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"fee_share_v2\": {\"type\": \"string\", \"enum\": [\"7ko7duEv4Gk5kRoJKGTRVgypuRHvTbCFbDeaC9Q4pWk3\"]},\n        \"meteora_damm_v2\": {\"type\": \"string\", \"enum\": [\"cpamdpZCGKUy5JxQXB4dcpGPiikHawvSWAd6mEn1sGG\"]},\n        \"meteora_dbc\": {\"type\": \"string\", \"enum\": [\"dbcij3LWUppWqq96dh6gJWwBifmcGfLSB5D4DuSMaqN\"]}\n      },\n      \"required\": [\"fee_share_v2\", \"meteora_damm_v2\", \"meteora_dbc\"]\n    },\n    \"file_upload_config\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"has_image_uploads\": {\"type\": \"boolean\"},\n        \"max_file_size_mb\": {\"type\": \"number\", \"enum\": [15]},\n        \"supported_types\": {\"type\": \"array\", \"items\": {\"type\": \"string\"}},\n        \"upload_strategy\": {\"type\": \"string\", \"enum\": [\"direct\", \"deferred\"]}\n      },\n      \"required\": [\"has_image_uploads\", \"max_file_size_mb\", \"supported_types\"]\n    },\n    \"idempotency_config\": {\n      \"type\": \"object\",\n      \"properties\": {\n        \"build_id\": {\"type\": \"string\"},\n        \"input_hash\": {\"type\": \"string\"},\n        \"deterministic_params\": {\"type\": \"object\"},\n        \"retry_strategy\": {\"type\": \"string\", \"enum\": [\"exponential_backoff\"]},\n        \"max_retries\": {\"type\": \"number\", \"enum\": [5]}\n      },\n      \"required\": [\"build_id\", \"input_hash\", \"deterministic_params\", \"retry_strategy\", \"max_retries\"]\n    }\n  },\n  \"required\": [\n    \"token_metadata\", \n    \"token_launch_params\", \n    \"fee_share_config\", \n    \"lookup_table_config\",\n    \"tipping_config\", \n    \"environment_config\", \n    \"program_ids\",\n    \"file_upload_config\",\n    \"idempotency_config\"\n  ]\n}\n```\n\n## EXECUTION STEPS\n\n### 1. Load Web3 Factory Constants\nUse centralized constants from `/web3-factory/constants/`:\n- `BAGS_API_CONFIG` for base URL and versioning\n- `BAGS_PROGRAM_IDS` for mainnet program addresses\n- `BAGS_LOOKUP_TABLES` for LUT configuration\n- `BAGS_TOKEN_LAUNCH` for launch parameters\n- `APP_FACTORY_PARTNER_KEY` for immutable partner attribution\n\n### 2. Extract Token Metadata (createTokenInfoAndMetadata)\nFrom W2 token model, prepare parameters for `createTokenInfoAndMetadata()`:\n- **name**: Token name (max 32 chars)\n- **symbol**: Token symbol (max 10 chars)\n- **description**: Token description (max 500 chars)\n- **image**: Image URL (from file upload or IPFS)\n- **website**: Optional website URL\n- **twitter**: Optional Twitter handle\n- **telegram**: Optional Telegram link\n\nValidate all parameters against Bags constraints.\n\n### 3. Configure Fee Sharing (createBagsFeeShareConfig)\nPrepare fee share configuration with App Factory partner:\n- **partnerKey**: Use `APP_FACTORY_PARTNER_KEY` (immutable)\n- **totalBPS**: Always 7500 (75% to creator, 25% to App Factory)\n- **feeClaimers**: Array with creator wallet and BPS allocation\n\nExample fee claimers:\n```json\n[\n  {\n    \"wallet\": \"<CREATOR_WALLET_ADDRESS>\",\n    \"bps\": 7500\n  }\n]\n```\n\n### 4. Determine Lookup Table Requirements\nBased on Bags principles:\n- **Required**: If fee claimers > 15\n- **Bags Public LUT**: Use `BAGS_LOOKUP_TABLES.MAINNET_LUT_ADDRESS`\n- **Custom LUT**: Only if required for fee claimers\n\nDocument LUT strategy and address requirements.\n\n### 5. Configure Tipping (Optional)\nBased on environment variables and Bags tipping principles:\n- Check `TIP_WALLET` and `TIP_LAMPORTS` environment variables\n- Validate tip wallet is valid Base58 Solana address\n- Ensure tip amount is within reasonable bounds (1000-500000 lamports)\n- Document tipping provider if applicable\n\n### 6. Environment Configuration\nValidate and document required environment variables:\n- **BAGS_API_KEY**: Required for all API calls\n- **SOLANA_RPC_URL**: Solana network endpoint\n- **SOLANA_NETWORK**: mainnet-beta or devnet\n- **CREATOR_WALLET_ADDRESS**: Creator's public key\n- **PRIVATE_KEY**: Required for transaction signing\n\nDo NOT access or validate actual values - only document requirements.\n\n### 7. File Upload Strategy\nBased on token metadata requirements:\n- Check if image uploads are needed\n- Document file size limits (15MB max)\n- List supported types: PNG, JPG, JPEG, GIF, WebP\n- Choose upload strategy: direct (W5) or deferred\n\n### 8. Program ID Configuration\nInclude all required Bags program IDs for mainnet:\n- **Fee Share V2**: `7ko7duEv4Gk5kRoJKGTRVgypuRHvTbCFbDeaC9Q4pWk3`\n- **Meteora DAMM v2**: `cpamdpZCGKUy5JxQXB4dcpGPiikHawvSWAd6mEn1sGG`\n- **Meteora DBC**: `dbcij3LWUppWqq96dh6gJWwBifmcGfLSB5D4DuSMaqN`\n\n### 9. Idempotency Configuration\nPrepare deterministic execution parameters:\n- **build_id**: From W1/W2 content hash\n- **input_hash**: SHA256 of all configuration inputs\n- **retry_strategy**: \"exponential_backoff\" per Bags error handling\n- **max_retries**: 5 attempts per Bags rate limiting principles\n\n## BAGS INTEGRATION PATTERNS\n\n### Token Creation Flow (W5 Reference)\n```javascript\n// Step 1: Create token info and metadata\nconst tokenInfo = await sdk.createTokenInfoAndMetadata({\n  name: config.token_metadata.name,\n  symbol: config.token_metadata.symbol,\n  description: config.token_metadata.description,\n  image: config.token_metadata.image // URL from upload\n});\n\n// Step 2: Create fee share configuration\nconst feeShareConfig = await sdk.createBagsFeeShareConfig({\n  partnerKey: \"FDYcVLxHkekUFz4M29hCuBH3vbf1aLm62GEFZxLFdGE7\",\n  totalBPS: 7500,\n  feeClaimers: [{\n    wallet: process.env.CREATOR_WALLET_ADDRESS,\n    bps: 7500\n  }]\n});\n\n// Step 3: Create launch transaction\nconst launchParams = {\n  ipfs: tokenInfo.ipfsHash,\n  tokenMint: tokenInfo.mint,\n  initialBuyAmount: config.token_launch_params.initialBuyAmount,\n  feeShareConfig: feeShareConfig,\n  // Optional tipping\n  tipWallet: config.tipping_config.tip_wallet,\n  tipLamports: config.tipping_config.tip_lamports\n};\n```\n\n### Rate Limiting Compliance\n- **Rate Limit**: 1,000 requests/hour (~16.7/minute)\n- **Retry Logic**: Exponential backoff for 429/500/502/503\n- **Headers**: Monitor X-RateLimit-Remaining\n- **No Retry**: 400/401/403/404 errors\n\n### Error Handling Strategy\n```javascript\n// Implement per Bags error handling principles\ntry {\n  const result = await bagsApiCall();\n  return result;\n} catch (error) {\n  if (error.status === 429) {\n    // Rate limited - implement backoff\n  } else if ([500, 502, 503].includes(error.status)) {\n    // Server error - retry with backoff\n  } else {\n    // Client error - do not retry\n    throw error;\n  }\n}\n```\n\n## SUCCESS CRITERIA\n\nW4 is successful when:\n- [ ] All token metadata extracted and formatted for `createTokenInfoAndMetadata()`\n- [ ] Fee share configuration prepared with immutable App Factory partner key\n- [ ] Lookup table requirements determined and documented\n- [ ] Tipping configuration prepared (if enabled)\n- [ ] Environment variable requirements documented (no access to values)\n- [ ] File upload strategy determined for token assets\n- [ ] Program IDs configuration includes all required mainnet addresses\n- [ ] Idempotency parameters generated for deterministic execution\n- [ ] All configuration validates against Bags SDK parameters\n- [ ] Rate limiting and error handling strategies documented\n\n## FAILURE CONDITIONS\n\nSTOP execution if:\n- Cannot map token model to Bags SDK `createTokenInfoAndMetadata()` parameters\n- Fee share configuration violates Bags constraints (>100 claimers, >10000 BPS)\n- Partner key is not the immutable App Factory key\n- Token metadata exceeds Bags field length limits\n- Required program IDs are missing or incorrect\n- Configuration does not match documented Bags patterns\n- Lookup table requirements cannot be determined\n\nWrite detailed failure analysis referencing specific Bags documentation sections.\n\n**DO NOT OUTPUT JSON IN CHAT**. Write all artifacts to disk only.
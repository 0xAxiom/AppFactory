# W5: Build & Ship (Bags-Compliant)\n\n## AGENT-NATIVE EXECUTION\nYou are Claude executing W5 for Web3 Factory. Create Solana token and generate complete web application using official Bags SDK patterns.\n\n## CRITICAL: TOKEN CREATION STAGE\n\nW5 is the ONLY stage that creates tokens and makes Bags API calls.\n\n**BAGS SDK RESPONSIBILITIES**:\n1. Execute `createTokenInfoAndMetadata()` for token metadata\n2. Execute `createBagsFeeShareConfig()` for fee routing\n3. Execute `createLaunchTransaction()` for token creation\n4. Sign transactions and confirm on Solana\n5. Generate complete production-ready web app\n\n## AUTHORITATIVE SOURCES (MANDATORY)\n\nImplement token creation following these exact guides:\n- **Launch Token Guide**: https://docs.bags.fm/how-to-guides/launch-token\n- **Rate Limits**: https://docs.bags.fm/principles/rate-limits\n- **Error Handling**: https://docs.bags.fm/principles/error-handling\n- **File Uploads**: https://docs.bags.fm/principles/file-uploads\n- **Lookup Tables**: https://docs.bags.fm/principles/lookup-tables\n\n## INPUTS\n- Read: `web3-factory/runs/.../w1/web3_idea.json`\n- Read: `web3-factory/runs/.../w2/token_model.json`\n- Read: `web3-factory/runs/.../w3/web3_architecture.json`\n- Read: `web3-factory/runs/.../w4/bags_config.json`\n\n## OUTPUTS\n- Write: `web3-factory/runs/.../w5/build_manifest.json`\n- Write: `web3-factory/runs/.../w5/w5_execution.md`\n- Create: `web3-factory/builds/<app_name>/` (complete web app)\n- Create: `web3-factory/builds/<app_name>/token/token_receipt.json`\n- Create: `web3-factory/builds/<app_name>/token/token_failure.json` (on failure)\n\n## BAGS SDK TOKEN CREATION FLOW\n\n### Step 1: Environment Validation\n``javascript\n// Validate all required environment variables\nconst requiredEnvVars = [\n  'BAGS_API_KEY',\n  'SOLANA_RPC_URL', \n  'SOLANA_NETWORK',\n  'CREATOR_WALLET_ADDRESS',\n  'PRIVATE_KEY'\n];\n\nfor (const varName of requiredEnvVars) {\n  if (!process.env[varName]) {\n    throw new Error(`Missing required environment variable: ${varName}`);\n  }\n}\n``\n\n### Step 2: Initialize Bags SDK\n`javascript\nimport { BagsSDK } from '@bagsfm/bags-sdk';\nimport { Connection, Keypair } from '@solana/web3.js';\nimport bs58 from 'bs58';\n\n// Initialize Solana connection\nconst connection = new Connection(process.env.SOLANA_RPC_URL, 'processed');\n\n// Initialize creator keypair\nconst creatorKeypair = Keypair.fromSecretKey(\n  bs58.decode(process.env.PRIVATE_KEY)\n);\n\n// Initialize Bags SDK\nconst sdk = new BagsSDK({\n  apiKey: process.env.BAGS_API_KEY,\n  connection: connection,\n  commitment: 'processed',\n  network: process.env.SOLANA_NETWORK\n});\n`\n\n### Step 3: Pre-flight Checks\n``javascript\n// Check Bags API health\nconst healthResponse = await fetch('https://public-api-v2.bags.fm/api/v1/ping', {\n  headers: { 'x-api-key': process.env.BAGS_API_KEY }\n});\n\nif (!healthResponse.ok || (await healthResponse.json()).message !== 'pong') {\n  throw new Error('Bags API health check failed');\n}\n\n// Check Solana connection\nconst latestBlockhash = await connection.getLatestBlockhash();\nconsole.log(`Connected to Solana ${process.env.SOLANA_NETWORK}`);\n\n// Check wallet balance\nconst balance = await connection.getBalance(creatorKeypair.publicKey);\nif (balance < 10000000) { // 0.01 SOL\n  console.warn('Low wallet balance - may not have enough SOL for fees');\n}\n``\n\n### Step 4: Process File Uploads (if needed)\n`javascript\n// Upload token image if required\nlet imageUrl = config.token_metadata.image;\n\nif (config.file_upload_config.has_image_uploads && !imageUrl) {\n  // TODO: Implement actual file upload per Bags file upload principles\n  // const uploadResponse = await uploadImageFile(imageFile, apiKey);\n  // imageUrl = uploadResponse.url;\n  \n  throw new Error('File upload implementation required - see /utils/file_upload.ts');\n}\n`\n\n### Step 5: Create Token Info and Metadata\n``javascript\nconst tokenInfo = await sdk.createTokenInfoAndMetadata({\n  name: config.token_metadata.name,\n  symbol: config.token_metadata.symbol,\n  description: config.token_metadata.description,\n  image: imageUrl,\n  website: config.token_metadata.website,\n  twitter: config.token_metadata.twitter,\n  telegram: config.token_metadata.telegram\n});\n\nconsole.log(`Token info created: ${tokenInfo.mint}`);\n``\n\n### Step 6: Create Fee Share Configuration\n`javascript\n// Prepare fee claimers from W4 config\nconst feeClaimers = config.fee_share_config.fee_claimers;\n\n// Handle lookup tables if required\nlet lookupTableAddress;\nif (config.lookup_table_config.custom_lut_required) {\n  // TODO: Implement lookup table creation per Bags lookup table principles\n  // const lutResult = await createLookupTableTransactions(connection, ...);\n  // lookupTableAddress = lutResult.address;\n  \n  throw new Error('Custom lookup table creation not implemented - see /utils/lookup_tables.ts');\n}\n\nconst feeShareConfig = await sdk.createBagsFeeShareConfig({\n  partnerKey: config.fee_share_config.partner_attribution.partner_key,\n  totalBPS: config.fee_share_config.total_bps,\n  feeClaimers: feeClaimers,\n  lookupTableAddress: lookupTableAddress // if custom LUT created\n});\n\nconsole.log('Fee share configuration created');\n`\n\n### Step 7: Create Launch Transaction\n`javascript\n// Prepare launch parameters\nconst launchParams = {\n  ipfs: tokenInfo.ipfsHash,\n  tokenMint: tokenInfo.mint,\n  initialBuyAmount: config.token_launch_params.initialBuyAmount,\n  feeShareConfig: feeShareConfig\n};\n\n// Add optional tipping\nif (config.tipping_config.enabled) {\n  launchParams.tipWallet = config.tipping_config.tip_wallet;\n  launchParams.tipLamports = config.tipping_config.tip_lamports;\n}\n\nconst launchTx = await sdk.createLaunchTransaction(launchParams);\n\nconsole.log('Launch transaction created');\n`\n\n### Step 8: Sign and Send Transaction\n``javascript\n// Sign transaction\nlaunchTx.sign(creatorKeypair);\n\n// Send and confirm transaction with retry logic\nconst signature = await connection.sendAndConfirmTransaction(launchTx, {\n  commitment: 'confirmed',\n  maxRetries: 5\n});\n\nconsole.log(`Token launched successfully: ${signature}`);\n``\n\n### Step 9: Generate Token Receipt\n`javascript\nconst receipt = {\n  buildId: config.idempotency_config.build_id,\n  tokenAddress: tokenInfo.mint.toString(),\n  transactionId: signature,\n  createdAt: new Date().toISOString(),\n  inputHash: config.idempotency_config.input_hash,\n  network: config.environment_config.network,\n  partner_attribution: {\n    partner_key: config.fee_share_config.partner_attribution.partner_key,\n    partner_program: config.fee_share_config.partner_attribution.partner_program\n  },\n  fee_split: {\n    creator_percentage: 75,\n    partner_percentage: 25\n  },\n  payout_destinations: {\n    creator_payout_address: process.env.CREATOR_WALLET_ADDRESS\n  },\n  bagsIntegration: {\n    sdkVersion: '@bagsfm/bags-sdk@latest',\n    apiEndpoint: config.environment_config.api_base_url,\n    partnerKey: config.fee_share_config.partner_attribution.partner_key\n  },\n  uploadedFiles: imageUrl ? [imageUrl] : [],\n  tipConfiguration: config.tipping_config.enabled ? {\n    wallet: config.tipping_config.tip_wallet,\n    lamports: config.tipping_config.tip_lamports\n  } : undefined\n};\n`\n\n## WEB APPLICATION GENERATION\n\n### Framework Selection\nBased on W3 architecture choice:\n- **Next.js**: Full-stack React with API routes\n- **Vite + React**: Client-side React with external APIs\n\n### Required Dependencies\n`json\n{\n  \"dependencies\": {\n    \"react\": \"^18.0.0\",\n    \"next\": \"^14.0.0\",\n    \"@solana/web3.js\": \"^1.87.0\",\n    \"@solana/wallet-adapter-react\": \"^0.15.0\",\n    \"@solana/wallet-adapter-wallets\": \"^0.19.0\",\n    \"tailwindcss\": \"^3.0.0\"\n  }\n}\n`\n\n### Core Components\n\n#### 1. Wallet Connection\n`jsx\n// src/components/WalletConnection.tsx\nimport { WalletAdapterNetwork } from '@solana/wallet-adapter-base';\nimport { ConnectionProvider, WalletProvider } from '@solana/wallet-adapter-react';\nimport { WalletModalProvider } from '@solana/wallet-adapter-react-ui';\n\nexport function WalletConnection({ children }: { children: React.ReactNode }) {\n  const network = WalletAdapterNetwork.Mainnet;\n  const endpoint = 'https://api.mainnet-beta.solana.com';\n  \n  return (\n    <ConnectionProvider endpoint={endpoint}>\n      <WalletProvider wallets={[]} autoConnect>\n        <WalletModalProvider>\n          {children}\n        </WalletModalProvider>\n      </WalletProvider>\n    </ConnectionProvider>\n  );\n}\n`\n\n#### 2. Token Integration\n`jsx\n// src/components/TokenDisplay.tsx\nimport { useConnection, useWallet } from '@solana/wallet-adapter-react';\nimport { PublicKey } from '@solana/web3.js';\n\nconst TOKEN_MINT = \"${receipt.tokenAddress}\"; // From token creation\n\nexport function TokenDisplay() {\n  const { connection } = useConnection();\n  const { publicKey } = useWallet();\n  \n  const [balance, setBalance] = useState(0);\n  \n  useEffect(() => {\n    if (publicKey) {\n      // Fetch token balance\n      connection.getTokenAccountsByOwner(publicKey, {\n        mint: new PublicKey(TOKEN_MINT)\n      }).then(accounts => {\n        // Calculate balance from accounts\n      });\n    }\n  }, [publicKey, connection]);\n  \n  return (\n    <div className=\"token-display\">\n      <h2>${config.token_metadata.name} (${config.token_metadata.symbol})</h2>\n      <p>Balance: {balance}</p>\n      <p>Token Address: {TOKEN_MINT}</p>\n    </div>\n  );\n}\n`\n\n#### 3. Token Actions (Based on Token Role)\n`jsx\n// src/components/TokenActions.tsx\n// Implementation varies based on token role from W2:\n\n// ACCESS token: Gate features behind balance check\nif (tokenRole === 'access') {\n  return (\n    <button \n      onClick={performAction}\n      disabled={balance < REQUIRED_AMOUNT}\n    >\n      {balance >= REQUIRED_AMOUNT ? 'Access Feature' : 'Insufficient Tokens'}\n    </button>\n  );\n}\n\n// USAGE token: Spend tokens for actions\nif (tokenRole === 'usage') {\n  return (\n    <button onClick={() => spendTokens(ACTION_COST)}>\n      Use Feature (Cost: {ACTION_COST} tokens)\n    </button>\n  );\n}\n\n// FEE_CAPTURE token: Display earnings\nif (tokenRole === 'fee_capture') {\n  return (\n    <div className=\"earnings-display\">\n      <h3>Your Earnings</h3>\n      <p>{earnedFees} tokens from app usage</p>\n    </div>\n  );\n}\n`\n\n## ERROR HANDLING & FAILURE MODES\n\n### Rate Limit Handling\n``javascript\n// Implement per Bags rate limiting principles\nconst withRateLimit = async (operation) => {\n  const maxRetries = 5;\n  let delay = 1000;\n  \n  for (let attempt = 1; attempt <= maxRetries; attempt++) {\n    try {\n      return await operation();\n    } catch (error) {\n      if (error.status === 429) {\n        console.warn(`Rate limited, retrying in ${delay}ms`);\n        await new Promise(resolve => setTimeout(resolve, delay));\n        delay *= 2; // Exponential backoff\n      } else {\n        throw error;\n      }\n    }\n  }\n};\n``\n\n### Failure Artifact Creation\n``javascript\n// On any failure, write detailed failure information\nconst writeFailureArtifacts = (error, stage, config) => {\n  const failureInfo = {\n    stage: stage,\n    error: error.message,\n    stack: error.stack,\n    config: config,\n    timestamp: new Date().toISOString(),\n    bags_api_status: 'unknown', // Result of health check\n    solana_network: process.env.SOLANA_NETWORK,\n    remediation_steps: [\n      '1. Check Bags API key validity at https://dev.bags.fm',\n      '2. Verify environment variables are set correctly',\n      '3. Check wallet balance for transaction fees',\n      '4. Review Bags API rate limits and retry later if needed'\n    ]\n  };\n  \n  // Write JSON failure report\n  fs.writeFileSync(\n    `web3-factory/builds/${appName}/token/token_failure.json`,\n    JSON.stringify(failureInfo, null, 2)\n  );\n  \n  // Write human-readable failure report\n  const failureMarkdown = `# Token Creation Failed\\n\\n` +\n    `**Error**: ${error.message}\\n` +\n    `**Stage**: ${stage}\\n` +\n    `**Time**: ${failureInfo.timestamp}\\n\\n` +\n    `## Remediation Steps\\n` +\n    failureInfo.remediation_steps.map(step => `- ${step}`).join('\\n');\n  \n  fs.writeFileSync(\n    `web3-factory/builds/${appName}/token/token_failure.md`,\n    failureMarkdown\n  );\n};\n``\n\n### Idempotency Implementation\n``javascript\n// Check for existing successful token creation\nconst checkExistingToken = (buildId, inputHash) => {\n  const receiptPath = `web3-factory/builds/${appName}/token/token_receipt.json`;\n  \n  if (fs.existsSync(receiptPath)) {\n    const existingReceipt = JSON.parse(fs.readFileSync(receiptPath, 'utf8'));\n    \n    if (existingReceipt.buildId === buildId && existingReceipt.inputHash === inputHash) {\n      console.log('Token already created with matching parameters, skipping creation');\n      return existingReceipt;\n    }\n  }\n  \n  return null;\n};\n``\n\n## BUILD OUTPUT STRUCTURE (MANDATORY)\n\n`\nweb3-factory/builds/<app_name>/\n├── package.json                    # Complete dependencies\n├── next.config.js                  # Next.js config (if Next.js)\n├── vite.config.js                  # Vite config (if Vite)\n├── tailwind.config.js              # Styling configuration\n├── .env.example                    # Environment variables template\n├── README.md                       # Setup and deployment instructions\n├── public/\n│   └── favicon.ico                 # App favicon\n├── src/\n│   ├── components/\n│   │   ├── WalletConnection.tsx    # Wallet connection\n│   │   ├── TokenDisplay.tsx        # Token balance display\n│   │   ├── TokenActions.tsx        # Token interaction\n│   │   └── TransactionHistory.tsx  # Transaction history\n│   ├── hooks/\n│   │   ├── useWallet.ts           # Wallet connection hook\n│   │   ├── useToken.ts            # Token operations hook\n│   │   └── useTransactions.ts     # Transaction management\n│   ├── services/\n│   │   ├── solana.ts              # Solana connection\n│   │   └── token.ts               # Token utilities\n│   ├── utils/\n│   │   └── constants.ts           # App and token constants\n│   └── pages/                     # App pages (Next.js) or App.tsx (Vite)\n├── token/\n│   ├── token_receipt.json         # Token creation receipt\n│   ├── token_receipt.md           # Human-readable receipt\n│   └── token_failure.json         # Failure report (if failed)\n└── deployment_guide.md            # Deployment instructions\n`\n\n## SUCCESS CRITERIA\n\nW5 is successful when:\n- [ ] Token successfully created via Bags SDK using official 3-step process\n- [ ] Token address captured and persisted in receipt\n- [ ] Complete web app generated with token integration\n- [ ] Token meaningfully integrated based on W2 token role\n- [ ] Fee routing (75%/25%) implemented with App Factory partner key\n- [ ] Rate limiting and error handling implemented per Bags principles\n- [ ] Idempotency ensures safe re-runs\n- [ ] App is production-ready with wallet connection\n- [ ] All failure modes write detailed failure artifacts\n\n## FAILURE CONDITIONS\n\nSTOP execution and write failure artifacts if:\n- Bags API health check fails\n- Environment variables missing or invalid\n- Solana connection fails\n- Wallet balance insufficient for transaction fees\n- Any step in Bags SDK 3-step process fails\n- Token creation transaction fails to confirm\n- Web app generation fails\n\n**CRITICAL**: Always write failure artifacts to help with debugging and remediation.\n\n**DO NOT OUTPUT JSON IN CHAT**. Write all artifacts to disk only.

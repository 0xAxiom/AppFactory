name: Security

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Mondays at 00:00 UTC
    - cron: "0 0 * * 1"

permissions:
  actions: read
  contents: read
  security-events: write

jobs:
  codeql:
    name: CodeQL Analysis
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: javascript-typescript
          queries: security-extended

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:javascript-typescript"

  trufflehog:
    name: TruffleHog Secret Scan
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: TruffleHog OSS
        uses: trufflesecurity/trufflehog@main
        with:
          path: ./
          base: ${{ github.event.repository.default_branch }}
          head: HEAD
          extra_args: --only-verified

  dependency-audit:
    name: Dependency Audit
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: "20"
          cache: "npm"

      - name: Audit root dependencies
        run: npm audit --audit-level=high
        continue-on-error: true

      - name: Install and audit CLI dependencies
        run: |
          cd CLI
          npm ci
          npm audit --audit-level=high
        continue-on-error: true

      - name: Install and audit dapp-factory dependencies
        run: |
          cd dapp-factory
          npm ci
          npm audit --audit-level=high
        continue-on-error: true

  secret-scan:
    name: Secret Pattern Scanning
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Scan for secrets
        run: |
          echo "Scanning for potential secrets..."

          # Check for common secret patterns
          patterns=(
            'AKIA[0-9A-Z]{16}'  # AWS Access Key
            'sk-[a-zA-Z0-9]{48}'  # OpenAI API Key
            'sk-ant-[a-zA-Z0-9-]{95,120}'  # Anthropic API Key
            'ghp_[a-zA-Z0-9]{36}'  # GitHub Personal Access Token
            'gho_[a-zA-Z0-9]{36}'  # GitHub OAuth Token
            'npm_[a-zA-Z0-9]{36}'  # NPM Token
            'xox[baprs]-[0-9a-zA-Z]{10,48}'  # Slack Token
          )

          found_secrets=0

          for pattern in "${patterns[@]}"; do
            if grep -rE "$pattern" --include="*.ts" --include="*.js" --include="*.json" --include="*.yml" --include="*.yaml" --exclude-dir=node_modules --exclude-dir=.git . 2>/dev/null; then
              echo "WARNING: Potential secret found matching pattern: $pattern"
              found_secrets=1
            fi
          done

          # Check for .env files that shouldn't be committed
          if find . -name ".env" -not -path "./node_modules/*" -not -path "./.git/*" | grep -q .; then
            echo "WARNING: .env file found (should not be committed)"
            find . -name ".env" -not -path "./node_modules/*" -not -path "./.git/*"
            found_secrets=1
          fi

          # Check for private keys
          if grep -rE "-----BEGIN (RSA|EC|OPENSSH|DSA|PRIVATE).*KEY-----" --include="*.pem" --include="*.key" --include="*.ts" --include="*.js" --exclude-dir=node_modules --exclude-dir=.git . 2>/dev/null; then
            echo "WARNING: Private key pattern found"
            found_secrets=1
          fi

          if [ $found_secrets -eq 1 ]; then
            echo ""
            echo "Secret scan found potential issues. Please review."
            exit 1
          else
            echo "No secrets detected!"
          fi

  license-check:
    name: License Check
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v6

      - name: Check LICENSE file
        run: |
          if [ -f "LICENSE" ] || [ -f "LICENSE.md" ] || [ -f "LICENSE.txt" ]; then
            echo "✓ License file found"
          else
            echo "✗ No license file found"
            exit 1
          fi

      - name: Verify package.json license
        run: |
          license=$(node -p "require('./package.json').license || 'NONE'")
          echo "Package license: $license"
          if [ "$license" = "MIT" ]; then
            echo "✓ Package license is MIT"
          else
            echo "⚠ Package license is not MIT: $license"
          fi

  security-complete:
    name: Security Complete
    needs: [codeql, trufflehog, dependency-audit, secret-scan, license-check]
    runs-on: ubuntu-latest
    if: always()
    steps:
      - name: Check security scan results
        run: |
          echo "=== Security Scan Summary ==="
          echo ""

          failed=0

          if [ "${{ needs.codeql.result }}" != "success" ]; then
            echo "WARNING: CodeQL analysis had findings"
          else
            echo "✓ CodeQL analysis passed"
          fi

          if [ "${{ needs.trufflehog.result }}" != "success" ]; then
            echo "FAIL: TruffleHog found potential secrets"
            failed=1
          else
            echo "✓ TruffleHog scan passed"
          fi

          if [ "${{ needs.secret-scan.result }}" != "success" ]; then
            echo "FAIL: Secret pattern scan found issues"
            failed=1
          else
            echo "✓ Secret pattern scan passed"
          fi

          if [ "${{ needs.dependency-audit.result }}" != "success" ]; then
            echo "WARNING: Dependency audit has findings"
          else
            echo "✓ Dependency audit passed"
          fi

          if [ "${{ needs.license-check.result }}" != "success" ]; then
            echo "FAIL: License check failed"
            failed=1
          else
            echo "✓ License check passed"
          fi

          echo ""
          if [ $failed -eq 1 ]; then
            echo "SECURITY SCAN FAILED: Review findings above"
            exit 1
          else
            echo "SECURITY SCAN PASSED"
          fi

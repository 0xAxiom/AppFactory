{
  "meta": {
    "run_id": "factory-094718",
    "idea_id": "kids_timer_004",
    "idea_name": "VisualBell",
    "idea_dir": "03_visualbell__kids_timer_004",
    "source_root": "/Users/melted/Documents/GitHub/app factory/the_factory/runs/2026-01-08/factory-094718/ideas/03_visualbell__kids_timer_004",
    "input_stage_paths": [
      "/Users/melted/Documents/GitHub/app factory/the_factory/runs/2026-01-08/factory-094718/ideas/03_visualbell__kids_timer_004/stages/stage02.json",
      "/Users/melted/Documents/GitHub/app factory/the_factory/runs/2026-01-08/factory-094718/ideas/03_visualbell__kids_timer_004/stages/stage02.5.json",
      "/Users/melted/Documents/GitHub/app factory/the_factory/runs/2026-01-08/factory-094718/ideas/03_visualbell__kids_timer_004/stages/stage02.7.json",
      "/Users/melted/Documents/GitHub/app factory/the_factory/runs/2026-01-08/factory-094718/ideas/03_visualbell__kids_timer_004/stages/stage03.json",
      "/Users/melted/Documents/GitHub/app factory/the_factory/runs/2026-01-08/factory-094718/ideas/03_visualbell__kids_timer_004/stages/stage04.json"
    ],
    "boundary_path": "/Users/melted/Documents/GitHub/app factory/the_factory/runs/2026-01-08/factory-094718/ideas/03_visualbell__kids_timer_004"
  },
  "architecture_overview": {
    "architectural_pattern": "Clean Architecture with Feature-Based Organization",
    "description": "Layered architecture separating UI, business logic, and data concerns with clear dependencies flowing inward. Feature-based organization groups related timer, theme, and subscription components.",
    "core_principles": [
      "Child-safe offline-first design with robust local persistence",
      "Timer accuracy prioritization with background resilience",
      "Premium feature gating through RevenueCat entitlements",
      "Performance optimization for smooth 60fps animations",
      "Simple state management appropriate for family-friendly app"
    ]
  },
  "system_architecture": {
    "application_layers": [
      {
        "layer": "Presentation Layer",
        "technologies": ["React Native", "React Navigation", "React Native Reanimated"],
        "responsibilities": [
          "Child-optimized UI components and touch interactions",
          "Timer visualization with smooth 60fps animations",
          "Theme rendering and animation management",
          "Parent settings interface and subscription paywall"
        ],
        "key_components": ["Screen Components", "UI Components", "Animation Controllers", "Theme Providers"]
      },
      {
        "layer": "Business Logic Layer",
        "technologies": ["Custom React Hooks", "Context API", "JavaScript Timer APIs"],
        "responsibilities": [
          "Timer accuracy management and background persistence",
          "Theme selection and animation coordination",
          "Premium feature access control via RevenueCat entitlements",
          "User preference and routine management"
        ],
        "key_components": ["Timer Manager", "Theme Manager", "Subscription Manager", "Settings Manager"]
      },
      {
        "layer": "Data Layer",
        "technologies": ["expo-sqlite", "AsyncStorage", "RevenueCat SDK"],
        "responsibilities": [
          "Local timer session and usage analytics storage",
          "Theme and preset configuration persistence",
          "Subscription state and entitlement management",
          "Parent settings and app configuration"
        ],
        "key_components": ["SQLite Repositories", "Preferences Store", "Subscription Service", "Analytics Collector"]
      }
    ],
    "cross_cutting_concerns": [
      {
        "concern": "Audio Management",
        "implementation": "expo-av for completion sounds with background audio session management",
        "architecture_impact": "Audio service layer with platform-specific configuration"
      },
      {
        "concern": "Background Processing",
        "implementation": "expo-notifications for timer completion alerts with accurate scheduling",
        "architecture_impact": "Background task coordination with foreground timer state"
      },
      {
        "concern": "Performance Monitoring",
        "implementation": "Custom performance tracking for animation frame rates and timer accuracy",
        "architecture_impact": "Performance metrics collection throughout application layers"
      },
      {
        "concern": "Child Safety",
        "implementation": "Architectural constraints preventing external navigation and data exposure",
        "architecture_impact": "Security boundaries between child and parent interfaces"
      }
    ]
  },
  "data_architecture": {
    "storage_strategy": {
      "primary_data_store": "expo-sqlite for structured timer and analytics data",
      "secondary_storage": "AsyncStorage for simple key-value preferences",
      "justification": "SQLite provides reliable local persistence for timer sessions and analytics while AsyncStorage handles simple configuration needs"
    },
    "database_schema": [
      {
        "table": "timer_sessions",
        "purpose": "Track individual timer usage for analytics and routine optimization",
        "columns": [
          "id INTEGER PRIMARY KEY",
          "duration_seconds INTEGER NOT NULL",
          "theme_id TEXT NOT NULL", 
          "completion_status TEXT NOT NULL", // 'completed', 'cancelled', 'interrupted'
          "start_timestamp INTEGER NOT NULL",
          "end_timestamp INTEGER",
          "preset_used TEXT", // if started from custom preset
          "child_interaction_count INTEGER DEFAULT 0" // pause/resume events
        ],
        "indexes": ["start_timestamp", "theme_id", "completion_status"],
        "retention": "Keep 6 months of session data for analytics"
      },
      {
        "table": "custom_presets",
        "purpose": "Store parent-configured timer presets for family routines",
        "columns": [
          "id INTEGER PRIMARY KEY",
          "name TEXT NOT NULL",
          "duration_seconds INTEGER NOT NULL",
          "theme_id TEXT NOT NULL",
          "icon_name TEXT",
          "created_timestamp INTEGER NOT NULL",
          "usage_count INTEGER DEFAULT 0",
          "is_favorite BOOLEAN DEFAULT 0"
        ],
        "constraints": ["UNIQUE(name)", "CHECK(duration_seconds > 0 AND duration_seconds <= 3600)"],
        "premium_gating": "Limited to 3 presets on free tier, 10 on premium"
      },
      {
        "table": "themes",
        "purpose": "Store theme metadata and unlock status",
        "columns": [
          "theme_id TEXT PRIMARY KEY",
          "display_name TEXT NOT NULL",
          "category TEXT NOT NULL", // 'default', 'space', 'underwater', etc.
          "is_premium BOOLEAN NOT NULL",
          "asset_version TEXT NOT NULL",
          "usage_count INTEGER DEFAULT 0",
          "last_used_timestamp INTEGER"
        ],
        "seed_data": "Populate with all available themes on app install"
      },
      {
        "table": "usage_analytics",
        "purpose": "Aggregate usage patterns for parent insights (local only)",
        "columns": [
          "date TEXT PRIMARY KEY", // YYYY-MM-DD format
          "total_timer_minutes INTEGER DEFAULT 0",
          "total_sessions INTEGER DEFAULT 0", 
          "completion_rate REAL DEFAULT 0.0", // percentage of timers completed
          "most_used_theme TEXT",
          "most_used_duration INTEGER",
          "weekly_consistency_score REAL DEFAULT 0.0"
        ],
        "privacy": "All data stored locally, never transmitted externally"
      }
    ],
    "async_storage_keys": [
      {
        "key": "user_preferences",
        "data": "JSON object with sound settings, parent PIN, onboarding status",
        "access_pattern": "Read on app start, write on settings change"
      },
      {
        "key": "subscription_cache",
        "data": "Cached RevenueCat entitlement status for offline access",
        "access_pattern": "Updated on subscription changes, read for premium feature gates"
      },
      {
        "key": "app_state",
        "data": "Last used theme, recently used presets, UI state preferences",
        "access_pattern": "Frequent read/write for app state restoration"
      }
    ]
  },
  "timer_management_architecture": {
    "timer_accuracy_strategy": {
      "approach": "Hybrid JavaScript + System Notifications",
      "implementation": [
        "Primary timer: JavaScript setInterval for UI updates and foreground accuracy",
        "Backup timer: expo-notifications scheduled notification for background completion",
        "Drift correction: Compare elapsed time vs expected progress on app foreground"
      ],
      "accuracy_targets": [
        "Foreground accuracy: ±100ms over any duration",
        "Background accuracy: ±1 second for completion notifications", 
        "UI update frequency: 100ms intervals for smooth progress animation"
      ]
    },
    "state_management": {
      "timer_state_machine": {
        "states": ["idle", "running", "paused", "completed", "cancelled"],
        "transitions": {
          "idle → running": "Start timer with duration and theme selection",
          "running → paused": "Child tap or background interrupt",
          "paused → running": "Child resume or foreground return",
          "running → completed": "Timer duration elapsed naturally",
          "any → cancelled": "Child stop action or parent intervention",
          "completed/cancelled → idle": "Automatic reset after celebration/acknowledgment"
        }
      },
      "concurrent_timers": {
        "architecture": "Multiple timer instance management for premium users",
        "implementation": "Array of timer state objects with unique IDs and visual coordination",
        "limitations": "Maximum 3 concurrent timers to prevent child confusion and maintain performance"
      }
    },
    "background_behavior": {
      "app_backgrounded": [
        "Schedule local notification for timer completion time",
        "Store current timer state and elapsed time in AsyncStorage",
        "Continue JavaScript timer if system allows background execution"
      ],
      "app_foregrounded": [
        "Calculate actual elapsed time since background",
        "Correct timer state based on real time passage",
        "Cancel scheduled notification if timer still running",
        "Resume smooth UI animations from correct progress point"
      ],
      "system_interruptions": [
        "Phone calls: Pause timer automatically, allow manual resume",
        "Low memory warnings: Persist state immediately, graceful degradation",
        "App termination: Restore timer state from AsyncStorage on next launch"
      ]
    }
  },
  "subscription_architecture": {
    "revenuecat_integration": {
      "sdk_configuration": {
        "initialization": "Configure RevenueCat SDK on app launch with platform-specific API keys",
        "user_identification": "Anonymous users with stable device-based identifier",
        "offline_handling": "Cache entitlement status in AsyncStorage for offline premium access"
      },
      "entitlement_management": {
        "premium_feature_gates": [
          "Theme access: Check 'premium_themes' entitlement before allowing selection",
          "Custom presets: Enforce limit based on 'custom_presets' entitlement", 
          "Multiple timers: Block concurrent timer creation without 'multiple_timers' entitlement",
          "Analytics access: Gate usage insights with 'usage_analytics' entitlement"
        ],
        "entitlement_caching": "Cache active entitlements locally, refresh on app foreground and subscription changes"
      },
      "purchase_flow_integration": {
        "paywall_triggers": [
          "Child selects locked premium theme",
          "Parent attempts to create 4th custom preset",
          "User tries to start second simultaneous timer",
          "Analytics access from parent settings"
        ],
        "purchase_completion": "Immediately refresh entitlements and unlock requested features",
        "restoration": "Restore purchases button in parent settings with clear feedback"
      }
    },
    "subscription_state_management": {
      "subscription_status_tracking": "Monitor active/expired/cancelled states with appropriate UI updates",
      "family_sharing_support": "Handle iOS Family Sharing and Google Play Family Library subscription access",
      "graceful_degradation": "Disable premium features smoothly when subscription expires, maintain user data"
    }
  },
  "performance_architecture": {
    "animation_performance": {
      "animation_system": {
        "primary_library": "React Native Reanimated for 60fps circular progress animations",
        "fallback_strategy": "React Native Animated API if Reanimated unavailable",
        "optimization_techniques": [
          "Use native driver for smooth animations",
          "Pre-calculate animation paths for complex themes",
          "Implement frame rate monitoring with graceful degradation"
        ]
      },
      "theme_rendering": {
        "asset_management": "Bundle theme assets locally to avoid network delays",
        "rendering_optimization": "Use react-native-svg for scalable theme graphics",
        "memory_management": "Lazy load theme assets, unload unused themes from memory"
      }
    },
    "app_startup_performance": {
      "cold_start_optimization": [
        "Minimize initial JavaScript bundle size",
        "Lazy load premium themes and non-essential features", 
        "Cache critical app state for faster subsequent launches",
        "Optimize SQLite database initialization"
      ],
      "warm_start_targets": "Sub-2 second app launch to timer-ready state"
    },
    "memory_management": {
      "timer_efficiency": "Lightweight timer objects with minimal memory footprint",
      "animation_memory": "Dispose of completed animations, reuse animation objects",
      "theme_caching": "Intelligent theme asset caching with memory pressure handling"
    }
  },
  "security_architecture": {
    "child_safety_measures": {
      "interface_isolation": [
        "Complete separation between child timer interface and parent settings",
        "No external URL links accessible from child interface",
        "Parent PIN protection for settings and subscription management"
      ],
      "data_protection": [
        "No child behavioral data collection beyond local timer usage",
        "All analytics data stored locally, never transmitted",
        "COPPA-compliant data handling with minimal data collection"
      ]
    },
    "subscription_security": {
      "purchase_verification": "Server-side receipt validation through RevenueCat",
      "entitlement_protection": "Secure entitlement checking to prevent premium feature bypass",
      "family_account_security": "Proper family sharing validation and cross-device synchronization"
    },
    "app_integrity": {
      "code_protection": "Standard React Native security practices with no additional obfuscation needed",
      "api_security": "RevenueCat handles all external API communication securely",
      "local_storage_security": "Sensitive parent settings encrypted in AsyncStorage"
    ]
  },
  "scalability_considerations": {
    "user_growth_handling": {
      "local_data_scaling": "SQLite database with appropriate indexes handles family usage data efficiently",
      "subscription_scaling": "RevenueCat platform handles subscription management scaling",
      "performance_scaling": "App architecture supports thousands of timer sessions without performance degradation"
    },
    "feature_expansion": {
      "new_themes": "Theme system architecture supports easy addition of new animation themes",
      "additional_premium_features": "Entitlement system easily extended for new subscription features",
      "platform_expansion": "Clean architecture supports future tablet-specific features"
    },
    "technical_debt_prevention": {
      "code_organization": "Feature-based organization prevents monolithic growth",
      "dependency_management": "Minimal external dependencies reduce maintenance burden",
      "testing_architecture": "Component isolation enables comprehensive unit and integration testing"
    }
  },
  "technology_stack": {
    "frontend": {
      "framework": "React Native 0.76.5 with Expo SDK 54+",
      "navigation": "Expo Router v4 for type-safe navigation",
      "animation": "React Native Reanimated 3.x for high-performance animations",
      "ui_components": "Custom child-optimized components built on React Native primitives"
    },
    "state_management": {
      "global_state": "React Context API for simple application state",
      "local_state": "React useState and useReducer for component-level state",
      "persistent_state": "Custom hooks wrapping AsyncStorage and SQLite access"
    },
    "data_persistence": {
      "structured_data": "expo-sqlite for timer sessions and analytics",
      "preferences": "@react-native-async-storage/async-storage for configuration",
      "subscription_data": "RevenueCat SDK handles subscription state persistence"
    },
    "audio_and_media": {
      "sound_playback": "expo-av for completion alerts and theme sounds",
      "haptic_feedback": "expo-haptics for child-friendly touch feedback",
      "graphics": "react-native-svg for scalable theme graphics and timer visuals"
    },
    "background_services": {
      "notifications": "expo-notifications for timer completion alerts",
      "task_management": "expo-task-manager for background timer coordination",
      "app_state": "react-native AppState API for foreground/background transitions"
    },
    "monetization": {
      "subscriptions": "react-native-purchases (RevenueCat) for cross-platform subscription management",
      "analytics": "Custom local analytics with no external tracking services"
    }
  },
  "deployment_architecture": {
    "build_configuration": {
      "development": "Expo Go for rapid development and testing",
      "staging": "Expo Development Build with RevenueCat sandbox environment",
      "production": "Expo Application Services (EAS) build with production RevenueCat configuration"
    },
    "environment_management": {
      "api_keys": "Environment-specific RevenueCat keys via expo-constants",
      "feature_flags": "Simple environment-based feature toggles for premium functionality",
      "configuration": "Dynamic app.config.js for environment-specific settings"
    },
    "release_strategy": {
      "versioning": "Semantic versioning with Expo SDK compatibility",
      "rollout": "Staged rollout through app stores with usage monitoring",
      "updates": "Over-the-air updates via Expo Updates for non-breaking changes"
    }
  }
}
# Asset Pipeline Hardening Report

**Date**: 2026-01-09
**Author**: Claude Code (Opus 4.5)
**Status**: COMPLETE

---

## Summary

Hardened the asset pipeline to make it impossible for a build to succeed unless all required app assets are valid PNG binaries with actual pixel data. This prevents release-blocking defects caused by invalid SVG content, empty files, or failed rasterization.

---

## Problem Addressed

Generated app assets (icon, adaptive-icon, splash, favicon) were sometimes invalid at runtime:
- SVG content saved as .png files
- Empty or placeholder files
- Failed image generation with tiny file sizes (e.g., 69 bytes)
- Expo rejection with "unsupported file type" errors

### Impact of Invalid Assets
- App icon blank on device
- App Store upload rejection
- Google Play rejection
- Splash screen crash on cold start
- Release-blocking defect class

---

## Files Created

| File | Purpose |
|------|---------|
| `scripts/verify_assets_are_png.sh` | Comprehensive PNG validation with multiple checks |

---

## Files Modified

| File | Changes |
|------|---------|
| `scripts/generate_assets.sh` | Added post-generation PNG validation (magic bytes, IDAT chunk, size threshold) |
| `templates/agents/10_app_builder.md` | Added gate 14 for PNG asset validation; added assets_validation_report.md to mandatory artifacts |

---

## Validation Pipeline

### Asset Flow (Enforced)
```
SVG (design source)
→ rasterize via sharp to PNG
→ verify binary signature
→ verify minimum file size
→ verify IDAT chunk (pixel data)
→ write to app/assets/
```

SVG files NEVER referenced directly by Expo config.

---

## Required Assets (Mandatory)

| Asset | Minimum Size | Dimensions |
|-------|-------------|------------|
| icon.png | 5 KB | 1024x1024 |
| adaptive-icon.png | 5 KB | 1024x1024 |
| splash.png | 10 KB | 1284x2778 |
| favicon.png | 500 B | 48x48 |

---

## Validation Checks (All Required)

### 1. File Existence
Asset file must be present in assets directory.

### 2. Minimum Size Threshold
Files must exceed minimum byte threshold:
- Catches empty files
- Catches placeholder outputs
- Catches failed generations

### 3. Not SVG Content
File content must not be SVG markup saved as .png:
- Checks for `<svg`, `<?xml`, `<!DOCTYPE svg` markers
- Rejects SVG content masquerading as PNG

### 4. PNG Magic Bytes
First 8 bytes must be: `89 50 4E 47 0D 0A 1A 0A`
- Standard PNG signature
- Proves file is binary PNG format

### 5. MIME Type Check
`file --mime-type` must report `image/png`
- OS-level format verification
- Catches misidentified file types

### 6. IDAT Chunk Present
PNG must contain IDAT chunk:
- IDAT contains actual image pixel data
- Proves image has renderable content
- Catches corrupt or incomplete PNGs

---

## Evidence Artifact

### assets_validation_report.md
Generated on every build with:
- Asset list with sizes
- MIME type verification
- PNG magic byte check
- IDAT chunk verification
- PASS/FAIL summary per asset

---

## Enforcement Integration

### Gate Ordering (Stage 10)

```
Gate 5:  generate_assets.sh (with built-in validation)
Gate 6:  verify_assets_present.sh
...
Gate 14: verify_assets_are_png.sh    <- NEW (final validation)
```

### Failure Behavior

Build FAILS immediately if:
- Any asset file missing
- Any asset below minimum size threshold
- Any asset contains SVG content instead of PNG
- Any asset has invalid PNG magic bytes
- Any asset missing IDAT chunk (no pixel data)
- Any asset has wrong MIME type

---

## generate_assets.sh Hardening

### Built-in Post-Generation Validation
After rasterization, the script now validates:
1. All 4 assets exist
2. All exceed minimum byte thresholds
3. All have correct PNG magic bytes
4. All have image/png MIME type
5. All contain IDAT chunks

If any check fails, exit code 3 (generation failure) is returned.

---

## Critical Rule

> A build may not succeed if any required visual asset is smaller than a minimum byte threshold or lacks valid PNG image data.

This catches:
- Empty files
- Placeholder outputs
- Failed image generations
- Broken SVG → PNG conversions

---

## No Silent Failures

The hardened pipeline ensures:
- No renaming tricks (SVG → .png rename)
- No silent generation failures
- No corrupt files accepted
- No placeholder images in production

---

*Report generated by pipeline enhancement task.*

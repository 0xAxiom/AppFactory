# Stage 03: UX Design

## AGENT-NATIVE EXECUTION

You are Claude Code (Opus 4.5) operating under the execution identity defined in CLAUDE.md.

Design comprehensive user experience based on product specifications and current UX standards.

## BUILD MODE VERIFICATION (CRITICAL)
Stage 03 can ONLY be executed via `build <IDEA_ID_OR_NAME>` command:
- Verify invocation came from build mode, not `run app factory`
- Require Stage 01-02 artifacts exist (hard-fail if missing)
- Assert this stage is building ONE SPECIFIC IDEA only
- Hard-fail if executed during batch idea generation

## STANDARDS CONTRACT (MANDATORY)
Read and comply with `standards/mobile_app_best_practices_2026.md`. Your output must include a "Standards Compliance Mapping" section demonstrating accessibility and design system requirements.

## INPUTS
- Read: `runs/.../ideas/<idea_dir>/stages/stage02.json` (product specification)
- Read: `runs/.../ideas/<idea_dir>/meta/idea.json` (canonical idea definition)
- Read: `runs/.../ideas/<idea_dir>/meta/boundary.json` (isolation enforcement)

## OUTPUTS
- Write: `runs/.../ideas/<idea_dir>/stages/stage03.json` (validated UX specification)
- Write: `runs/.../ideas/<idea_dir>/outputs/stage03_execution.md` (execution log with decisions)
- Write: `runs/.../ideas/<idea_dir>/outputs/stage03_research.md` (UX research citations)
- Render: `runs/.../ideas/<idea_dir>/spec/03_ux_design.md` (specification markdown)
- **Write: `runs/.../ideas/<idea_dir>/uiux/uiux_prompt.md` (BINDING design contract)**
- **Write: `runs/.../ideas/<idea_dir>/uiux/design_tokens.json` (color/typography system)**
- **Write: `runs/.../ideas/<idea_dir>/uiux/component_inventory.md` (required UI components)**
- **Write: `runs/.../ideas/<idea_dir>/uiux/interaction_expectations.md` (behavior specifications)**
- Update: `runs/.../ideas/<idea_dir>/meta/stage_status.json` (progress tracking)

## FRESHNESS & SOURCES (MANDATORY WEB RESEARCH)
You MUST browse current sources to avoid outdated UI patterns:

### Required Research Sources
**Design Standards** (Must consult):
- **Apple HIG**: Latest Human Interface Guidelines for iOS design patterns
- **Material Design 3**: Current Android design system requirements
- **Accessibility Guidelines**: WCAG 2.1 AA standards and platform accessibility docs
- **Category UX Patterns**: Browse 3-5 live apps in same category for current UX trends

### Design Inspiration Sources (RECOMMENDED)
**Modern UI/UX Pattern Galleries** (Browse for cutting-edge inspiration):
- **Figma Community**: https://www.figma.com/community/mobile-apps
- **Uizard Templates**: https://uizard.io/templates/mobile-app-templates/
- **Visily Templates**: https://www.visily.ai/templates/mobile-app-templates/
- **Dribbble Mobile**: https://dribbble.com/tags/mobile-app-design

**STRICT INSPIRATION RULES**:
1. **INSPIRATION, NOT COPYING**: Synthesize patterns, do NOT replicate designs verbatim
2. **THEME-FIRST FILTER**: Reject any inspiration that doesn't align with app domain and user intent
3. **NO BRANDING COPYING**: Do NOT recreate another app's branding or identity
4. **ABSTRACTED REFERENCES**: Document pattern types, not specific design names/links in final output

### Research Focus Areas
1. **Navigation Patterns**: How users expect to move through apps in this category
2. **Onboarding Flows**: Current best practices for user activation and value demonstration
3. **Information Architecture**: How similar apps organize content and features
4. **Accessibility Standards**: Platform-specific accessibility implementations
5. **Premium Experience**: How successful apps differentiate free vs premium UX
6. **Soft Paywall Patterns**: Non-intrusive monetization UX that demonstrates value first
7. **Review Prompt Timing**: Best practices for requesting reviews post-onboarding

### Citation Requirements
Document research in `stage03_research.md`:
- Design pattern sources and examples (abstracted, non-specific)
- Accessibility requirement interpretations
- Category-specific UX conventions
- How research influenced design decisions
- **Design Inspiration Synthesis**: Types of apps referenced, patterns adopted, theme adaptations

## BOUNDARY ENFORCEMENT
This stage must ONLY read from:
- Current idea pack: `runs/.../ideas/<idea_dir>/`
- Global standards: `standards/mobile_app_best_practices_2026.md`

## JSON SCHEMA

```json
{
  "meta": {
    "run_id": "string",
    "idea_id": "string", 
    "idea_name": "string",
    "idea_dir": "string",
    "source_root": "string",
    "input_stage_paths": ["array of files read"],
    "boundary_path": "string"
  },
  "ux_design": {
    "design_inspiration": {
      "app_theme": "string (e.g., utility, productivity, creative, wellness, finance)",
      "emotional_tone": "string (e.g., calm, energetic, premium, minimal, bold, professional)",
      "design_archetype": "string (e.g., 'Forensic Instrument Panel', 'Calm Productivity Hub')",
      "inspiration_synthesis": {
        "pattern_categories_referenced": ["string (e.g., 'modern productivity apps', 'media library apps')"],
        "navigation_model_rationale": "string",
        "layout_style_rationale": "string",
        "component_style_rationale": "string",
        "rejected_inspirations": ["string (patterns that didn't fit theme)"]
      }
    },
    "user_journey": {
      "onboarding_flow": {
        "purpose": "education|personalization|value_framing|hybrid",
        "screen_count": "number (2-5)",
        "skip_allowed": "boolean",
        "screens": [
          {
            "step": "number",
            "screen_name": "string",
            "core_message": "string",
            "visual_elements": ["string"],
            "user_action": "string",
            "exit_condition": "string"
          }
        ],
        "visual_tone_alignment": "string (how visuals match app theme)",
        "completion_trigger": "string (what marks onboarding complete)"
      },
      "core_usage_flow": [
        {
          "step": "string",
          "screen": "string",
          "user_action": "string",
          "content": "string",
          "goal": "string"
        }
      ]
    },
    "soft_paywall_ux": {
      "trigger_conditions": ["string (e.g., 'after 3 free uses', 'when accessing premium feature')"],
      "value_preview": "string (what user sees before gating)",
      "paywall_placement": "non_blocking|contextual|feature_gated",
      "copy_tone": "helpful|encouraging|informative (NOT aggressive)",
      "upgrade_framing": "string (focus on what improves, not what is locked)",
      "dismissal_behavior": "string (how user closes without upgrading)",
      "free_tier_continuation": "string (how app remains useful after dismiss)"
    },
    "review_prompt_ux": {
      "trigger_timing": "immediately_after_onboarding|after_first_success|delayed",
      "placement": "string (where in flow the prompt appears)",
      "request_copy": "string (grateful, not demanding)",
      "explanation": "string (why review is being requested)",
      "dismissal_without_penalty": "boolean (always true)",
      "visual_style": "modal|inline|toast",
      "platform_api_usage": "string (App Store Review API, etc.)"
    },
    "information_architecture": {
      "primary_navigation": {
        "type": "tab|drawer|stack",
        "sections": ["string"],
        "rationale": "string"
      },
      "content_hierarchy": {
        "levels": ["string"],
        "organization_principle": "string"
      }
    },
    "wireframes": {
      "home_screen": {
        "layout": "string",
        "primary_cta": "string",
        "secondary_elements": ["string"],
        "accessibility_notes": "string"
      },
      "core_feature_screens": [
        {
          "screen_name": "string",
          "purpose": "string",
          "layout": "string",
          "key_elements": ["string"],
          "accessibility_notes": "string"
        }
      ]
    },
    "interaction_patterns": {
      "primary_actions": {
        "action": "string",
        "interaction": "string",
        "feedback": "string"
      },
      "navigation_gestures": ["string"],
      "accessibility_alternatives": ["string"]
    },
    "visual_design_direction": {
      "brand_personality": "string",
      "color_strategy": {
        "primary": "string with contrast ratios",
        "secondary": "string",
        "accessibility_compliant": "boolean"
      },
      "typography": {
        "primary_font": "string",
        "scale_factor": "string for dynamic type",
        "readability_notes": "string"
      }
    },
    "accessibility_requirements": {
      "wcag_compliance": "WCAG 2.1 AA",
      "screen_reader_support": ["string"],
      "motor_accessibility": ["string"],
      "visual_accessibility": ["string"],
      "cognitive_accessibility": ["string"]
    }
  }
}
```

## EXECUTION STEPS

### Phase 1: Research & Standards Review
1. Read product specifications from stage02.json
2. Research current design standards and accessibility requirements
3. Analyze category-specific UX patterns and conventions
4. Review platform guidelines for navigation and interaction patterns
5. **Browse design inspiration sources** (Figma Community, Dribbble, etc.) for cutting-edge patterns
6. **Apply theme-first filter**: Identify app theme and emotional tone, reject non-aligned inspiration

### Phase 1.5: Theme & Design Inspiration Analysis (MANDATORY)
7. **Identify App Theme**: Determine core category (utility, productivity, creative, wellness, finance)
8. **Identify Emotional Tone**: Define feel (calm, energetic, premium, minimal, bold, professional)
9. **Choose Design Archetype**: Select appropriate visual personality for the domain
10. **Document Inspiration Synthesis**:
    - Pattern categories referenced (abstracted, non-specific)
    - Navigation model rationale based on research
    - Component style rationale based on theme alignment
    - Rejected patterns and why they didn't fit

### Phase 2: Information Architecture
11. Design primary navigation structure based on product features
12. Organize content hierarchy for optimal user task completion
13. Map user flows from onboarding through core feature usage
14. Plan premium experience differentiation

### Phase 3: Wireframe Design
15. Design home screen layout optimizing for primary user goals
16. Create wireframes for all core feature screens
17. Design interaction patterns for key user actions
18. Specify accessibility considerations for each screen

### Phase 4: Visual Direction
19. Define brand personality aligned with target users
20. Specify color strategy with accessibility compliance
21. Select typography with dynamic type support
22. Document visual design principles

### Phase 5: Onboarding Flow Definition (MANDATORY)
23. **Define Onboarding Purpose**: Education, personalization, value framing, or hybrid
24. **Plan Screen Count**: Typically 2-5 screens based on complexity
25. **Design Each Onboarding Screen**:
    - Core message per screen
    - Visual elements aligned with app theme
    - User action and progression trigger
    - Exit conditions (completion, skip)
26. **Ensure Visual Tone Alignment**: Onboarding must feel like part of the app

### Phase 6: Soft Paywall UX Definition (MANDATORY)
27. **Define Trigger Conditions**: When the paywall appears (usage-based, feature-based)
28. **Design Value Preview**: What user sees before any gating
29. **Set Copy Tone**: Helpful and informative, NOT aggressive or demanding
30. **Frame Upgrade Positively**: Focus on what improves, not what is locked
31. **Plan Dismissal Behavior**: How user closes without upgrading, no penalty
32. **Ensure Free Tier Viability**: App remains useful after paywall dismiss

### Phase 7: Review Prompt UX Definition (MANDATORY)
33. **Set Trigger Timing**: Immediately after successful onboarding completion
34. **Design Request Copy**: Grateful tone, clear explanation of why review helps
35. **Ensure Non-Intrusive Placement**: Dismissible without penalty or app impact
36. **Plan Platform API Usage**: App Store Review API (iOS), In-App Review API (Android)
37. **Align Visual Style**: Modal or toast that matches app theme

### Phase 8: BINDING Design Contract Creation (MANDATORY)
38. **Generate UI/UX Design Contract**:
    - Write `uiux/uiux_prompt.md` with exact role and design-system structure
    - Include domain-appropriate design philosophy and visual language
    - Specify cutting-edge UI patterns relevant to app category
    - **Include design inspiration synthesis documentation**

39. **Create Design Token System**:
    - Write `uiux/design_tokens.json` with complete color palette, typography, spacing
    - Colors MUST match app domain (EVP = dark/forensic, wellness = calm/breathable)
    - Include accessibility-compliant contrast ratios

40. **Define Component Inventory**:
    - Write `uiux/component_inventory.md` listing ALL required UI components
    - Specify domain-specific components (waveforms for EVP, meters, charts)
    - Include component behavior and interaction patterns
    - **Include onboarding, soft paywall, and review prompt components**

41. **Document Interaction Expectations**:
    - Write `uiux/interaction_expectations.md` with specific behavior requirements
    - Recording states, feedback patterns, transition animations
    - Error states, loading patterns, empty states
    - **Onboarding transitions, paywall animations, review prompt behavior**

### Phase 9: Validation & Documentation
42. Validate design against accessibility standards
43. Ensure guest-first experience design
44. **Verify onboarding, soft paywall, and review prompt are fully defined**
45. Write JSON with complete UX specification
46. Document research influence on design decisions
47. **Include Design Inspiration Synthesis section in research output**
48. Render human-readable UX specification

## STANDARDS COMPLIANCE MAPPING

### Accessibility & Design System (MANDATORY)
- **Requirement**: WCAG 2.1 AA compliance with 4.5:1 contrast ratios
- **Implementation**: All color combinations tested for contrast, alternative text specified
- **Validation**: Screen reader support documented, touch targets ≥44pt iOS/48dp Android

### Subscription UX Requirements
- **Requirement**: Clear premium value communication in UX
- **Implementation**: Premium features clearly distinguished with upgrade paths
- **Validation**: Paywall UX follows honest disclosure principles

### Platform Compliance
- **Requirement**: Follow iOS and Android design guidelines
- **Implementation**: Navigation patterns align with platform conventions
- **Validation**: Interaction patterns follow platform standards

### Inclusive Design
- **Requirement**: Support for reduced motion, large text, voice control
- **Implementation**: Alternative interactions specified for accessibility needs
- **Validation**: Design works at 200% text scaling and reduced motion settings

## SUCCESS CRITERIA
Stage 03 is complete when:
- [ ] `stage03.json` exists and validates against schema
- [ ] `stage03_research.md` documents design research and standards
- [ ] **Design inspiration synthesis documented** with theme, tone, and pattern rationale
- [ ] User flows designed for guest-first experience with premium upgrades
- [ ] All screens meet accessibility requirements with specific implementations
- [ ] Navigation and interaction patterns follow platform conventions
- [ ] Visual design direction supports subscription business model
- [ ] **Onboarding flow fully defined** (2-5 screens, purpose, visual tone)
- [ ] **Soft paywall UX fully defined** (trigger, tone, dismissal, free tier viability)
- [ ] **Review prompt UX fully defined** (timing, copy, dismissible, platform API)

## HARD FAILURE CONDITIONS
- Schema validation failure → Write `stage03_failure.md` and stop
- Accessibility requirements not met → Write `stage03_failure.md` and stop
- Design conflicts with subscription model → Write `stage03_failure.md` and stop
- Platform guideline violations → Write `stage03_failure.md` and stop
- **Missing onboarding flow definition** → Write `stage03_failure.md` and stop
- **Missing soft paywall UX definition** → Write `stage03_failure.md` and stop
- **Missing review prompt UX definition** → Write `stage03_failure.md` and stop
- **Generic UI patterns without theme alignment** → Write `stage03_failure.md` and stop
- Boundary violation (reading from wrong idea pack) → Write `stage03_failure.md` and stop

DO NOT output JSON in chat. Write all artifacts to disk and continue with Stage 04.
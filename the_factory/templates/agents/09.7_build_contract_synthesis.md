# Stage 09.7: Build Contract Synthesis (Pre-Stage 10 Gate)

## AGENT-NATIVE EXECUTION

You are Claude Code (Opus 4.5) operating under the execution identity defined in CLAUDE.md.

Synthesize ALL stage outputs into a single, deterministic build contract that becomes the SOLE AUTHORITATIVE INPUT for Stage 10.

## BUILD MODE VERIFICATION (CRITICAL)
Stage 09.7 can ONLY be executed via `build <IDEA_ID_OR_NAME>` command or `dream <IDEA_TEXT>` command:
- Verify invocation came from build mode, not `run app factory`
- Require Stages 01, 02-09.5 artifacts exist (hard-fail if missing)
- Assert this stage is building ONE SPECIFIC IDEA only
- Hard-fail if executed during batch idea generation

## PURPOSE (MANDATORY GATE)
This stage synthesizes ALL information from stages 02-09.5 into a single, comprehensive build contract that contains EVERYTHING Stage 10 needs to build a complete app. Stage 10 will NOT read individual stage files - only the build contract.

**SYNTHESIS TARGETS**:
- All product specifications from stages 02-09.5
- All UX designs, flows, and wireframes
- All monetization and subscription requirements  
- All technical architecture decisions
- All brand identity and visual design specifications
- All runtime validation requirements

## EXECUTION METHODOLOGY

### Step 1: Execute Build Contract Synthesis Script
Run the synthesis script to generate contract artifacts:
```bash
scripts/build_contract_synthesis.sh runs/.../ideas/<idea_dir>
```

This script will:
- Validate all required stage artifacts exist
- Extract and normalize data from all stage JSONs
- Perform web research if needed (cached locally)
- Generate comprehensive build prompt in required format
- Create traceability manifest
- Validate contract completeness

### Step 2: Verify Contract Completeness
Run verification scripts to ensure contract meets requirements:
```bash
scripts/verify_build_contract_present.sh runs/.../ideas/<idea_dir>
scripts/verify_build_contract_sections.sh runs/.../ideas/<idea_dir>
```

Both verifiers must PASS or Stage 09.7 fails.

### Step 3: Create Stage 09.7 Artifacts
After successful synthesis and verification:

## INPUTS
- Read: All previous stage JSONs (`runs/.../ideas/<idea_dir>/stages/stage02.json` through `stage09.5.json`)
- Read: `runs/.../ideas/<idea_dir>/meta/idea.json` (canonical idea definition)
- Read: `vendor/expo-docs/` and `vendor/revenuecat-docs/` (technical guidance)
- Reference: `standards/mobile_app_best_practices_2026.md` (compliance requirements)

## OUTPUTS
- Execute: `scripts/build_contract_synthesis.sh <idea_dir>` (generates contract artifacts)
- Write: `runs/.../ideas/<idea_dir>/stages/stage09.7.json` (synthesis metadata)
- Write: `runs/.../ideas/<idea_dir>/outputs/stage09.7_execution.md` (execution log)
- Update: `runs/.../ideas/<idea_dir>/meta/stage_status.json` (progress tracking)

**Contract Artifacts Created by Script**:
- `runs/.../ideas/<idea_dir>/app/_contract/build_contract.json` (structured data)
- `runs/.../ideas/<idea_dir>/app/_contract/build_prompt.md` (authoritative build instructions)
- `runs/.../ideas/<idea_dir>/app/_contract/contract_sources.json` (traceability manifest)

## BUILD CONTRACT REQUIREMENTS (ENFORCED BY VERIFIERS)

The generated `build_prompt.md` MUST contain exactly these sections:

1. **PURPOSE** - Cite ship-ready app goal
2. **ROLE** - Senior React Native developer instructions
3. **APP OVERVIEW** - Name and one-sentence description
4. **TARGET PLATFORM** - Expo React Native, iOS + Android
5. **BUSINESS MODEL** - Subscription-only monetization
6. **MONETIZATION RULES** - RevenueCat integration requirements
7. **CORE FEATURES (MVP)** - Numbered feature list from core loop
8. **DESIGN REQUIREMENTS** - UI/UX specifications from Stage 03
9. **DESIGN SYSTEM REQUIREMENTS** - Brand and accessibility specs
10. **TECHNICAL REQUIREMENTS** - Expo compatibility, canonical docs usage
11. **ASSETS** - Asset generation and brand compliance requirements
12. **PIPELINE ENFORCEMENT** - No improvisation, stage traceability
13. **OUTPUT EXPECTATIONS** - Complete Expo app in builds/ directory
14. **EXECUTION INSTRUCTIONS** - Step-by-step build process

## CRITICAL REQUIREMENTS

### Completeness Verification
- All sections must be populated with actual content, not placeholders
- All requirements must be derived from existing stage outputs
- If stage outputs are insufficient, Stage 09.7 MUST FAIL with specific error

### No Improvisation Rule
- Stage 09.7 can only synthesize existing stage data
- Cannot invent missing requirements or features
- Cannot fill gaps with assumptions or defaults
- Must use deterministic synthesis from stage artifacts

### Web Research Caching
- Any web research performed must be cached in `app/_docs/`
- All sources must be registered in `app/_docs/sources.json` with SHA256
- No external references allowed unless locally cached
- Vendor docs (expo-docs/, revenuecat-docs/) are pre-approved

## SUCCESS CRITERIA

Stage 09.7 is complete when:
- [ ] `scripts/build_contract_synthesis.sh` executes successfully
- [ ] `scripts/verify_build_contract_present.sh` passes
- [ ] `scripts/verify_build_contract_sections.sh` passes  
- [ ] `build_prompt.md` contains all 14 required sections
- [ ] `build_contract.json` contains normalized stage data
- [ ] `contract_sources.json` traces all input artifacts
- [ ] `stage09.7.json` created with synthesis metadata
- [ ] `stage09.7_execution.md` created with execution log

## HARD FAILURE CONDITIONS

- Stage artifacts 02-09.5 missing → Write `stage09.7_failure.md` and stop
- Contract synthesis script fails → Write `stage09.7_failure.md` and stop
- Contract verification fails → Write `stage09.7_failure.md` and stop
- Required contract sections missing → Write `stage09.7_failure.md` and stop
- Unable to synthesize complete requirements → Write `stage09.7_failure.md` and stop

## STAGE 10 PREPARATION

After Stage 09.7 completes successfully:
- Stage 10 will read ONLY the build contract, not individual stage files
- Stage 10 will validate contract completeness before building
- Stage 10 will fail if contract is incomplete or unclear
- NO improvisation or gap-filling allowed in Stage 10

This contract becomes the single source of truth for the final app build.

DO NOT output contract content in chat. Execute synthesis script and write artifacts to disk only.